# hdbet container test suite
# Tests for HD-BET v1.0.0 - Deep learning brain extraction tool
#
# HD-BET (HD Brain Extraction Tool) was developed with MRI-data from a large
# multicentric clinical trial in adult brain tumor patients. It uses deep
# learning for robust brain extraction across various MRI sequences (T1w, T2w,
# FLAIR, etc.) and is particularly robust to tumors, lesions, and resection
# cavities.
#
# Test data: ds000001/sub-01 (OpenNeuro Balloon Analog Risk-taking Task)
#   - T1w: 160x192x192, 1x1.33x1.33mm (3D structural)
#
# Reference: Isensee F, et al. Automated brain extraction of multi-sequence MRI
# using artificial neural networks. arXiv preprint arXiv:1901.11341, 2019.

name: hdbet
version: 1.0.0
container: hdbet_1.0.0_20210318.simg

test_data:
  t1w: ds000001/sub-01/anat/sub-01_T1w.nii.gz
  t2: ds000001/sub-01/anat/sub-01_inplaneT2.nii.gz
  output_dir: test_output

setup:
  script: |
    #!/usr/bin/env bash
    set -e
    mkdir -p test_output
    mkdir -p test_output/hdbet_batch

tests:
  # ==========================================================================
  # BASIC FUNCTIONALITY
  # ==========================================================================
  - name: Help display
    description: Verify hd-bet binary runs and shows help message
    command: hd-bet --help 2>&1
    expected_output_contains: "usage: hd-bet"

  - name: Help mentions input argument
    description: Verify help shows input argument documentation
    command: hd-bet --help 2>&1
    expected_output_contains: "-i INPUT"

  - name: Help mentions output argument
    description: Verify help shows output argument documentation
    command: hd-bet --help 2>&1
    expected_output_contains: "-o OUTPUT"

  - name: Help mentions mode options
    description: Verify help explains fast vs accurate modes
    command: hd-bet --help 2>&1
    expected_output_contains: "fast"

  - name: Help mentions device options
    description: Verify help explains device selection (CPU/GPU)
    command: hd-bet --help 2>&1
    expected_output_contains: "cpu"

  # ==========================================================================
  # BRAIN EXTRACTION - FAST MODE (CPU)
  # ==========================================================================
  - name: Brain extraction fast mode CPU
    description: Test basic brain extraction using fast mode on CPU
    command: hd-bet -i ${t1w} -o test_output/t1w_brain_fast -device cpu -mode fast -tta 0
    validate:
      - output_exists: ${output_dir}/t1w_brain_fast.nii.gz
    timeout: 600

  - name: Brain mask generated fast mode
    description: Verify brain mask is generated alongside brain extraction
    command: hd-bet -i ${t1w} -o test_output/t1w_brain_fast_mask_test -device cpu -mode fast -tta 0 -s 1
    validate:
      - output_exists: ${output_dir}/t1w_brain_fast_mask_test.nii.gz
      - output_exists: ${output_dir}/t1w_brain_fast_mask_test_mask.nii.gz
    timeout: 600

  - name: Verify fast mode brain output dimensions
    description: Ensure brain extraction preserves original image dimensions
    command: |
      hd-bet -i ${t1w} -o test_output/t1w_brain_dims_test -device cpu -mode fast -tta 0 2>&1 && \
      python3 -c "import nibabel as nib; \
        orig = nib.load('${t1w}'); \
        brain = nib.load('test_output/t1w_brain_dims_test.nii.gz'); \
        assert orig.shape == brain.shape, f'Shape mismatch: {orig.shape} vs {brain.shape}'; \
        print('Dimensions match:', orig.shape)"
    expected_output_contains: "Dimensions match"
    timeout: 600

  # ==========================================================================
  # BRAIN EXTRACTION - ACCURATE MODE (CPU)
  # ==========================================================================
  - name: Brain extraction accurate mode CPU
    description: Test brain extraction using accurate mode (ensemble of 5 models)
    command: hd-bet -i ${t1w} -o test_output/t1w_brain_accurate -device cpu -mode accurate -tta 0
    validate:
      - output_exists: ${output_dir}/t1w_brain_accurate.nii.gz
    timeout: 1200

  - name: Brain mask generated accurate mode
    description: Verify brain mask is generated in accurate mode
    command: hd-bet -i ${t1w} -o test_output/t1w_brain_accurate_mask_test -device cpu -mode accurate -tta 0 -s 1
    validate:
      - output_exists: ${output_dir}/t1w_brain_accurate_mask_test.nii.gz
      - output_exists: ${output_dir}/t1w_brain_accurate_mask_test_mask.nii.gz
    timeout: 1200

  # ==========================================================================
  # TEST TIME AUGMENTATION (TTA)
  # ==========================================================================
  - name: Brain extraction with TTA disabled
    description: Test brain extraction with test time augmentation disabled
    command: hd-bet -i ${t1w} -o test_output/t1w_brain_no_tta -device cpu -mode fast -tta 0
    validate:
      - output_exists: ${output_dir}/t1w_brain_no_tta.nii.gz
    timeout: 600

  - name: Brain extraction with TTA enabled
    description: Test brain extraction with test time augmentation enabled (slower but potentially more accurate)
    command: hd-bet -i ${t1w} -o test_output/t1w_brain_with_tta -device cpu -mode fast -tta 1
    validate:
      - output_exists: ${output_dir}/t1w_brain_with_tta.nii.gz
    timeout: 900

  # ==========================================================================
  # POSTPROCESSING OPTIONS
  # ==========================================================================
  - name: Brain extraction with postprocessing enabled
    description: Test brain extraction with postprocessing (largest connected component)
    command: hd-bet -i ${t1w} -o test_output/t1w_brain_pp_on -device cpu -mode fast -tta 0 -pp 1
    validate:
      - output_exists: ${output_dir}/t1w_brain_pp_on.nii.gz
    timeout: 600

  - name: Brain extraction with postprocessing disabled
    description: Test brain extraction without postprocessing
    command: hd-bet -i ${t1w} -o test_output/t1w_brain_pp_off -device cpu -mode fast -tta 0 -pp 0
    validate:
      - output_exists: ${output_dir}/t1w_brain_pp_off.nii.gz
    timeout: 600

  # ==========================================================================
  # MASK SAVING OPTIONS
  # ==========================================================================
  - name: Save both brain and mask
    description: Test saving both skull-stripped brain and binary mask
    command: hd-bet -i ${t1w} -o test_output/t1w_brain_save_mask -device cpu -mode fast -tta 0 -s 1
    validate:
      - output_exists: ${output_dir}/t1w_brain_save_mask.nii.gz
      - output_exists: ${output_dir}/t1w_brain_save_mask_mask.nii.gz
    timeout: 600

  - name: Do not save mask
    description: Test saving only skull-stripped brain without mask
    command: hd-bet -i ${t1w} -o test_output/t1w_brain_no_mask_save -device cpu -mode fast -tta 0 -s 0
    validate:
      - output_exists: ${output_dir}/t1w_brain_no_mask_save.nii.gz
    timeout: 600

  # ==========================================================================
  # OUTPUT VERIFICATION
  # ==========================================================================
  - name: Verify mask is binary
    description: Ensure the brain mask contains only 0 and 1 values
    command: |
      hd-bet -i ${t1w} -o test_output/t1w_brain_binary_check -device cpu -mode fast -tta 0 -s 1 2>&1 && \
      python3 -c "import nibabel as nib; import numpy as np; \
        mask = nib.load('test_output/t1w_brain_binary_check_mask.nii.gz').get_fdata(); \
        unique_vals = np.unique(mask); \
        assert np.all(np.isin(unique_vals, [0, 1])), f'Mask not binary, found: {unique_vals}'; \
        print('Mask is binary with values:', unique_vals)"
    expected_output_contains: "Mask is binary"
    timeout: 600

  - name: Verify brain extraction removes skull
    description: Check that brain extraction reduces non-zero voxels (skull removed)
    command: |
      hd-bet -i ${t1w} -o test_output/t1w_brain_skull_check -device cpu -mode fast -tta 0 2>&1 && \
      python3 -c "import nibabel as nib; import numpy as np; \
        orig = nib.load('${t1w}').get_fdata(); \
        brain = nib.load('test_output/t1w_brain_skull_check.nii.gz').get_fdata(); \
        orig_nonzero = np.count_nonzero(orig); \
        brain_nonzero = np.count_nonzero(brain); \
        assert brain_nonzero < orig_nonzero, f'Brain should have fewer non-zero voxels: {brain_nonzero} vs {orig_nonzero}'; \
        print(f'Skull removed: {orig_nonzero} -> {brain_nonzero} non-zero voxels')"
    expected_output_contains: "Skull removed"
    timeout: 600

  - name: Verify affine preserved
    description: Ensure affine transformation matrix is preserved
    command: |
      hd-bet -i ${t1w} -o test_output/t1w_brain_affine_check -device cpu -mode fast -tta 0 2>&1 && \
      python3 -c "import nibabel as nib; import numpy as np; \
        orig = nib.load('${t1w}'); \
        brain = nib.load('test_output/t1w_brain_affine_check.nii.gz'); \
        if not np.allclose(orig.affine, brain.affine): \
          print('Warning: affine matrices differ slightly'); \
        print('Affine check completed')"
    expected_output_contains: "Affine check"
    timeout: 600

  # ==========================================================================
  # ALTERNATIVE MRI SEQUENCES
  # ==========================================================================
  - name: Brain extraction T2 weighted image
    description: Test brain extraction on T2-weighted (inplane) image
    command: hd-bet -i ${t2} -o test_output/t2_brain -device cpu -mode fast -tta 0
    validate:
      - output_exists: ${output_dir}/t2_brain.nii.gz
    timeout: 600

  - name: T2 brain mask generated
    description: Verify brain mask generated for T2 image
    command: hd-bet -i ${t2} -o test_output/t2_brain_with_mask -device cpu -mode fast -tta 0 -s 1
    validate:
      - output_exists: ${output_dir}/t2_brain_with_mask.nii.gz
      - output_exists: ${output_dir}/t2_brain_with_mask_mask.nii.gz
    timeout: 600

  # ==========================================================================
  # OVERWRITE BEHAVIOR
  # ==========================================================================
  - name: Overwrite existing output
    description: Test overwriting existing output files
    command: |
      hd-bet -i ${t1w} -o test_output/t1w_brain_overwrite -device cpu -mode fast -tta 0 2>&1 && \
      hd-bet -i ${t1w} -o test_output/t1w_brain_overwrite -device cpu -mode fast -tta 0 --overwrite_existing 1 2>&1
    validate:
      - output_exists: ${output_dir}/t1w_brain_overwrite.nii.gz
    timeout: 1200

  - name: Skip existing output
    description: Test skipping when output already exists
    command: |
      hd-bet -i ${t1w} -o test_output/t1w_brain_skip -device cpu -mode fast -tta 0 2>&1 && \
      hd-bet -i ${t1w} -o test_output/t1w_brain_skip -device cpu -mode fast -tta 0 --overwrite_existing 0 2>&1
    validate:
      - output_exists: ${output_dir}/t1w_brain_skip.nii.gz
    timeout: 1200

  # ==========================================================================
  # CITATION AND INFO
  # ==========================================================================
  - name: Citation displayed
    description: Verify citation information is displayed when running
    command: hd-bet --help 2>&1
    expected_output_contains: "Isensee"

  # ==========================================================================
  # ERROR HANDLING
  # ==========================================================================
  - name: Error on missing input
    description: Test error handling when input file does not exist
    command: hd-bet -i nonexistent_file.nii.gz -o test_output/error_test -device cpu -mode fast -tta 0 2>&1 || echo "Error handled correctly"
    expected_output_contains: "Error handled correctly"

  - name: Error on invalid mode
    description: Test error handling with invalid mode parameter
    command: hd-bet -i ${t1w} -o test_output/error_mode -device cpu -mode invalid_mode -tta 0 2>&1 || echo "Invalid mode handled"
    expected_output_contains: "handled"

  # ==========================================================================
  # COMBINED OPTIONS TESTS
  # ==========================================================================
  - name: Full options fast mode
    description: Test all options combined in fast mode
    command: hd-bet -i ${t1w} -o test_output/t1w_brain_full_fast -device cpu -mode fast -tta 0 -pp 1 -s 1 --overwrite_existing 1
    validate:
      - output_exists: ${output_dir}/t1w_brain_full_fast.nii.gz
      - output_exists: ${output_dir}/t1w_brain_full_fast_mask.nii.gz
    timeout: 600

  - name: Full options accurate mode
    description: Test all options combined in accurate mode
    command: hd-bet -i ${t1w} -o test_output/t1w_brain_full_accurate -device cpu -mode accurate -tta 0 -pp 1 -s 1 --overwrite_existing 1
    validate:
      - output_exists: ${output_dir}/t1w_brain_full_accurate.nii.gz
      - output_exists: ${output_dir}/t1w_brain_full_accurate_mask.nii.gz
    timeout: 1200

  # ==========================================================================
  # PERFORMANCE COMPARISON
  # ==========================================================================
  - name: Compare fast vs accurate mode output
    description: Compare outputs from fast and accurate modes
    command: |
      hd-bet -i ${t1w} -o test_output/t1w_compare_fast -device cpu -mode fast -tta 0 -s 1 2>&1 && \
      hd-bet -i ${t1w} -o test_output/t1w_compare_accurate -device cpu -mode accurate -tta 0 -s 1 2>&1 && \
      python3 -c "import nibabel as nib; import numpy as np; \
        fast_mask = nib.load('test_output/t1w_compare_fast_mask.nii.gz').get_fdata(); \
        accurate_mask = nib.load('test_output/t1w_compare_accurate_mask.nii.gz').get_fdata(); \
        dice = 2 * np.sum(fast_mask * accurate_mask) / (np.sum(fast_mask) + np.sum(accurate_mask)); \
        print(f'Dice coefficient between fast and accurate modes: {dice:.4f}')"
    expected_output_contains: "Dice coefficient"
    timeout: 1800

  # ==========================================================================
  # MASK APPLICATION
  # ==========================================================================
  - name: Apply generated mask to original
    description: Verify mask can be applied to recreate brain extraction
    command: |
      hd-bet -i ${t1w} -o test_output/t1w_mask_apply -device cpu -mode fast -tta 0 -s 1 2>&1 && \
      python3 -c "import nibabel as nib; import numpy as np; \
        orig = nib.load('${t1w}'); \
        mask = nib.load('test_output/t1w_mask_apply_mask.nii.gz').get_fdata(); \
        brain = nib.load('test_output/t1w_mask_apply.nii.gz').get_fdata(); \
        applied = orig.get_fdata() * mask; \
        diff = np.abs(applied - brain); \
        max_diff = np.max(diff); \
        print(f'Maximum difference when reapplying mask: {max_diff}')"
    expected_output_contains: "Maximum difference"
    timeout: 600

  # ==========================================================================
  # OUTPUT INTEGRITY
  # ==========================================================================
  - name: Verify NIfTI format integrity
    description: Ensure output is valid NIfTI format
    command: |
      hd-bet -i ${t1w} -o test_output/t1w_nifti_check -device cpu -mode fast -tta 0 2>&1 && \
      python3 -c "import nibabel as nib; \
        img = nib.load('test_output/t1w_nifti_check.nii.gz'); \
        print(f'Valid NIfTI: shape={img.shape}, dtype={img.get_data_dtype()}')"
    expected_output_contains: "Valid NIfTI"
    expected_exit_code: 0
    timeout: 600

  - name: Verify no NaN values in output
    description: Ensure brain extraction output contains no NaN values
    command: |
      hd-bet -i ${t1w} -o test_output/t1w_nan_check -device cpu -mode fast -tta 0 2>&1 && \
      python3 -c "import nibabel as nib; import numpy as np; \
        brain = nib.load('test_output/t1w_nan_check.nii.gz').get_fdata(); \
        nan_count = np.sum(np.isnan(brain)); \
        assert nan_count == 0, f'Found {nan_count} NaN values'; \
        print('No NaN values in output')"
    expected_output_contains: "No NaN values"
    timeout: 600

  - name: Verify no negative values in mask
    description: Ensure mask contains no negative values
    command: |
      hd-bet -i ${t1w} -o test_output/t1w_negative_check -device cpu -mode fast -tta 0 -s 1 2>&1 && \
      python3 -c "import nibabel as nib; import numpy as np; \
        mask = nib.load('test_output/t1w_negative_check_mask.nii.gz').get_fdata(); \
        neg_count = np.sum(mask < 0); \
        assert neg_count == 0, f'Found {neg_count} negative values'; \
        print('No negative values in mask')"
    expected_output_contains: "No negative values"
    timeout: 600

  # ==========================================================================
  # STATISTICAL VALIDATION
  # ==========================================================================
  - name: Brain volume reasonable
    description: Verify extracted brain volume is within reasonable range
    command: |
      hd-bet -i ${t1w} -o test_output/t1w_volume_check -device cpu -mode fast -tta 0 -s 1 2>&1 && \
      python3 -c "import nibabel as nib; import numpy as np; \
        img = nib.load('test_output/t1w_volume_check_mask.nii.gz'); \
        mask = img.get_fdata(); \
        voxel_volume = np.abs(np.prod(img.header.get_zooms()[:3])); \
        brain_volume_ml = np.sum(mask) * voxel_volume / 1000; \
        print(f'Estimated brain volume: {brain_volume_ml:.1f} mL'); \
        assert 800 < brain_volume_ml < 2000, f'Brain volume {brain_volume_ml} mL outside expected range'; \
        print('Brain volume within expected range (800-2000 mL)')"
    expected_output_contains: "Brain volume within expected range"
    expected_exit_code: 0
    timeout: 600

cleanup:
  script: |
    #!/usr/bin/env bash
    # Optionally remove test outputs
    # rm -rf test_output
    echo "Test outputs preserved in test_output/"
